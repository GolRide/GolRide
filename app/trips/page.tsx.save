"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { Card } from "@/components/ui/Card";
import { Input } from "@/components/ui/Input";
import { Button } from "@/components/ui/Button";

type Trip = {
  _id: string;
  origin: string;
  destination: string;
  date: string;
  match: string;
  team: string;
  seatsAvailable: number;
  seatsTotal: number;
  priceCents: number;
  creator?: {
    username?: string;
    avatar?: string;
  };
};

function formatDate(value: string) {
  const d = new Date(value);
  if (Number.isNaN(d.getTime())) return value;
  return d.toLocaleDateString("es-ES", { year: "numeric", month: "2-digit", day: "2-digit" });
}

function initials(name: string) {
  const s = (name || "").trim();
  if (!s) return "U";
  const parts = s.split(/\s+/).slice(0, 2);
  return parts.map(p => p[0]?.toUpperCase()).join("") || "U";
}

export default function TripsPage() {
  const [origin, setOrigin] = useState("");
  const [destination, setDestination] = useState("");
  const [team, setTeam] = useState("");
  const [date, setDate] = useState("");

  const [loading, setLoading] = useState(false);
  const [trips, setTrips] = useState<Trip[]>([]);
  const [error, setError] = useState<string | null>(null);

  const query = useMemo(() => {
    const p = new URLSearchParams();
    if (origin.trim()) p.set("origin", origin.trim());
    if (destination.trim()) p.set("destination", destination.trim());
    if (team.trim()) p.set("team", team.trim());
    if (date.trim()) p.set("date", date.trim());
    return p.toString();
  }, [origin, destination, team, date]);

  async function fetchTrips() {
    setLoading(true);
    setError(null);

    try {
      const res = await fetch(`/api/trips?${query}`, { cache: "no-store" });
      const data = await res.json();
      setTrips(Array.isArray(data?.trips) ? data.trips : []);
    } catch {
      setError("No se pudieron cargar los viajes.");
      setTrips([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    fetchTrips();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  return (
    <div className="mx-auto max-w-6xl px-4 py-14">
      <div className="mx-auto max-w-4xl">
        <Card title="Buscar viajes" desc="Resultados con protagonismo y diseño en azul.">

          {/* RESULTADOS */}
          <div className="mt-6 grid gap-3">
            {!loading && trips.length === 0 && (
              <div className="rounded-2xl border border-blue-100 bg-blue-50/40 p-4 text-sm text-zinc-700">
                No hay viajes con esos filtros.
              </div>
            )}

            {trips.map((t) => {
              const priceEur = (t.priceCents / 100).toFixed(2);
              const username = t.creator?.username || "Usuario";
              const avatar = t.creator?.avatar || "";

              return (
                <Link key={t._id} href={`/trips/${t._id}`} className="block">
                  <div className="rounded-2xl border border-blue-200 bg-white p-4 transition hover:border-blue-400 hover:bg-blue-50/20">
                    <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">

                      {/* IZQUIERDA */}
                      <div>
                        <div className="text-lg font-semibold">
                          {t.origin} <span className="text-blue-600">→</span> {t.destination}
                        </div>

                        <div className="text-sm text-zinc-700">
                          <span className="font-medium text-blue-700">{t.team}</span> • {t.match}
                        </div>

                        <div className="mt-2 flex items-center gap-2 text-sm">
                          <span className="inline-flex h-8 w-8 items-center justify-center rounded-full border border-blue-200 bg-blue-50 text-blue-700 font-semibold">
                            {avatar ? (
                              <img src={avatar} alt={username} className="h-full w-full object-cover rounded-full" />
                            ) : (
                              initials(username)
                            )}
                          </span>
                          <span>Publicado por <b>{username}</b></span>
                        </div>
                      </div>

                      {/* PRECIO */}
                      <div className="rounded-xl bg-blue-600 px-4 py-3 text-white">
                        <div className="text-xs">Precio / plaza</div>
                        <div className="text-2xl font-bold">{priceEur}€</div>
                      </div>

                    </div>
                  </div>
                </Link>
              );
            })}
          </div>
        </Card>
      </div>
    </div>
  );
}

